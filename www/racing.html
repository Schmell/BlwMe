<head>
  <style type="text/css" id="mine"></style>
  <link rel="stylesheet" href="css/racing.css"></link>
  <!-- dropdown styling -->
  <style> 
    .dropbtn {
      background-color: #4CAF50;
      color: white;
      padding: 16px;
      font-size: 16px;
      border: none;
      cursor: pointer;
    }
    
    .dropdown {
      position: relative;
      display: inline-block;
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
    }
    
    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
    }
    
    .dropdown-content a:hover {background-color: #f1f1f1}
    
    .dropdown:hover .dropdown-content {
      display: block;
    }
    
    .dropdown:hover .dropbtn {
      background-color: #3e8e41;
    }
  </style>
</head>
<body>
  <div id="main">
    <div id="infoPane">
      <div id="raceSelect">
        <!-- raceSelected template -- option only-->
        <select id="raceSelector" defaultraceid=""></select>
      </div>
      <!-- NEEDTO: set value from raceData -->
      <div id="startTime"><input id="startTimeInput" type="text" value="18:35:00" size="9"/>
       <br/> <div id="startSetBtn" class="btn">Set Start</div>
      </div>
      <div id="save" class="btn">save</div>
      <div id="clock"></div>
      <div id="raceInfo"></div>
    </div>
                
    <div id="mainPane">
      <table cellpadding="0" cellspacing="5px" width="100%">
        <tr><td>
            <div id="compPane">
              <div class="app">
                <table class="appTable" cellpadding="0" cellspacing="5px" height="1400px">
                  <!-- replaced by compTemplate -->
                </table>
              </div><!-- app -->
            </div><!-- compPane -->
          </td><!-- compPane cell -->
          <td width="160px" id="btnPaneCell">          
            <div id="btnPane">
            <div id="finishBtn" class="btn"><div class="finishLabel">Finish</div></div>
            <div id="codeBtn" class="btn"><div id="codeLabel">Set Code</div></div>    
            <div id="codeSelect">
              <select>
                  <option value="DNF">DNF</option>
                  <option value="OCS">OCS</option>
                  <option value="DSQ">DSQ</option>
                  <option value="RAF">RAF</option>
              </select>
            </div>
            <div id="finishPane"><!-- Replaced by finishPaneTemplate --></div>
          </td><!-- btn cell -->
        </tr>
      </table><!-- mainPaneTable -->
    </div> <!-- mainPane -->
  </div><!-- main -->

  </body> 
    
    <!-- Templates -->
    <template id="raceSelectItems">
        <div class="dropdown">
          <button class="dropbtn">Dropdown</button>
          <div class="dropdown-content">
          <a href="#">Link 1</a>
          <a href="#">Link 2</a>
          <a href="#">Link 3</a>
          </div>
        </div>
    </template>

    <template id="finishPaneTemplate">
      <!-- need to set finishListTitle textContent and <ol> id -->
      <ul class="finishListTitle"><!-- <?= fleets[i] ?> -->
        <ol id="" class="finishList"></ol>
      </ul>
    </template>
    
    <template id="compTemplate">
      <tr><td>
        <table id="" class="compPanel" cellpadding="0" cellspacing="0" data-id="">
          <tr class="compRow">
            <td class="boat">
              <div class="cueNo"></div>
              <div class="helm"></div>
              <div class="boatName"></div>
              <div class="fleet"></div>
              <div class="rating"></div>
              <div class="compId"></div>
              <div class="start hidden"></div>
              <div class="date hidden"></div>
            </td>
            <td width="20px">
              <div class="adj">
                <ul>
                  <li class="button plus">+</li>
                  <li class="button minus">-</li>
                </ul>
              </div>
            </td>
            <td class="time">
              <table class="timeTable" cellpadding="0" cellspacing="0">
              <tr>
                <td class="timeDisplay"></td>
              </tr>
              </table>
            </td>
          </tr>
        </table>
      </td></tr>
    </template>
    
    <script src="js/colorChanger.js"></script>
    <script src="js/importFile.js"></script><!-- change to localStorageManager -->
    <!-- <script src="js/dbUtility.js" defer></script> -->
    <script src="js/papaparse.min.js"></script>
    
<script name="indexedDB_stuff" type="text/javascript">

    var db;
    var dbPromise;
    var updateDB = false
    const dbVersion = 6;
    function openDatabase(name){
        if (!window.indexedDB) { console.log("Your browser doesn't support a stable version of IndexedDB."); }

        let dbPromise = indexedDB.open(name, dbVersion);
    
        dbPromise.onupgradeneeded = function(e) {
            console.log('onupgradeneeded');
            db = e.target.result;
        
            if (!db.objectStoreNames.contains('races')) {
                let store = db.createObjectStore('races', {keyPath: 'id'});
                store.createIndex("name", "name", { unique: true });
                store.createIndex("date", "date", { unique: false });
                store.createIndex("time", "time", { unique: false });
                store.createIndex("sailed", "sailed", { unique: false });
            }
        
            if (!db.objectStoreNames.contains('comps')) {
                let store = db.createObjectStore('comps', {keyPath: 'id'});
                store.createIndex("id", "id", { unique: true });
                store.createIndex("compid", "compid", { unique: false });
                store.createIndex("boat", "boat", { unique: true });
                store.createIndex("fleet", "fleet", { unique: false });
                store.createIndex("helm", "helm", { unique: true });
                store.createIndex("sailno", "sailno", { unique: false });
                store.createIndex("class", "class", { unique: false });
                store.createIndex("rank", "rank", { unique: false });
                store.createIndex("nett", "nett", { unique: false });
                store.createIndex("total", "total", { unique: false });
            }
        
            if (!db.objectStoreNames.contains('fleets')) {
                let store = db.createObjectStore('fleets', {keyPath: 'id'});
                store.createIndex("name", "name", { unique: false });
            }
        
            if (!db.objectStoreNames.contains('results')) { 
                let store = db.createObjectStore('results', {keyPath: 'id', autoIncrement:true});
                store.createIndex("raceid", "raceid", { unique: false });
                store.createIndex("compid", "compid", { unique: false });
                store.createIndex("start", "start", { unique: false });
                store.createIndex("elapsed", "elapsed", { unique: false });
                store.createIndex("finish", "finish", { unique: false });
            }
            if (!db.objectStoreNames.contains('series')) { 
                let store = db.createObjectStore('series', {keyPath: 'id'});
            }
            if (!db.objectStoreNames.contains('using')) { 
                let store = db.createObjectStore('using', {keyPath: 'id'});
            }

            return db;
    
        }; // onupgradeneeded
    
        dbPromise.onerror = function(e) { console.warn("Error", e.target.result); };
        dbPromise.onblocked = function(e) { console.warn("onblocked", e.target.result); }
        dbPromise.onsuccess = function(e) {
            db = e.target.result;
            writeAllDB(db)
            return db;
        };

    } // openDatabase
    var dbw = openDatabase('store');

    function writeCompsDB(db){
      let comps = Csv.getComps()
      let transaction = db.transaction("comps", "readwrite");
      let compsData = transaction.objectStore("comps");
      comps.forEach(function(comps){
        let comp = {
            'boat': comps.compboat, 
            'rating': comps.comprating, 
            'fleet': comps.compfleet, 
            'id': comps.compid, 
            'helm': comps.comphelmname, 
            'alias':comps.compalias, 
            'club':comps.compclub, 
            'exclude':comps.compexclude, 
            'high':comps.comphigh, 
            'medicalflag':comps.compmedicalflag, 
            'nett':comps.compnett, 
            'rank':comps.comprank, 
            'total':comps.comptotal
          }
        let request = compsData.add(comp);
        //console.log(comp);
      });
    }
    function writeFleetsDB(db){
         let fleets = Csv.getFleets();
        let tx = makeTX('fleets', 'readwrite');
        let store = tx.objectStore('fleets')
        for (let i = 0; i < fleets.length; i++) {
          let fleet = {'name':fleets[i],'id':i}
          let request = store.put(fleet);
        }
        store.onerror = function(e){
          console.warn('onerror',e)
        }
    } 
    function writeRacesDB(db){
        let races = Csv.getRaces();
        let transaction = makeTX("races", "readwrite");
        let racesData = transaction.objectStore("races");
        
        for (let i = 0; i < races.length; i++) {
          let race = {
            'id':races[i].id,
            'raceid':races[i].raceid,
            'name':races[i].racename,
            'date':races[i].racedate, 
            'notes':races[i].racenotes, 
            'rank':races[i].racerank, 
            'sailed': races[i].racesailed, 
            'start':races[i].racestart, 
            'time':races[i].racetime
            }
          let request = racesData.put(race);
          //console.log('race',race);
        }
    }
    function writeResultsDB(db){
        let results = Csv.getResults();
        let transaction = makeTX("results", "readwrite");
        let resultsData = transaction.objectStore("results");
        for (let i = 0; i < results.length; i++) {
            let request = resultsData.put(results[i]);
            //console.log(results[i]);
        }
    }
    function writeSeriesDB(db){
      let results = Csv.getSeries()
      let tx = makeTX('series', 'readwrite')
      let resultsData = tx.objectStore("series");
      for (let i = 0; i < results.length; i++) {
        results[i].id = 1
        let request = resultsData.add(results[i]);
        //console.log(results[i]);
      }
    }
    function writeUsingDB(db){
      let using = localStorage.getItem('using')
      //LL(JSON.parse(using))
      let jsoned = JSON.parse(using)
      jsoned.id = 1
      let tx = makeTX('using', 'readwrite')
      let store = tx.objectStore("using");
      store.add(jsoned)

    }
    function writeAllDB(db){
      let using = JSON.parse(localStorage.getItem('using')).lastModifiedDate
      let tx = makeTX('using', 'readwrite')
      let store = tx.objectStore("using").get(1)
      store.onsuccess = (e)=>{
        let dbv = e.target.result
        if(using == dbv.lastModifiedDate && !updateDB){
          console.log('File matches DB no update required')
        }else{
          console.log('File does not match DB, updating')
            writeRacesDB(db);
            writeCompsDB(db);
            writeFleetsDB(db)
            writeResultsDB(db)
            writeSeriesDB(db)
            writeUsingDB(db)
        }
      }
    }
    
</script>

<script type="text/javascript">
//LazyLog
var LL = console.log;

function makeTX(storeName,mode){
  //console.log('makeTX',db)
  let tx = db.transaction(storeName, mode);
  //LL(tx)
  tx.onerror = (err) => {
    console.error('makeTX onerror',err.target.error);
  }
  return tx;
}

function getStore(storeName,mode){
  if(mode == 'undefined'){mode = 'readwrite'}
  let tx = makeTX(storeName,mode).objectStore(storeName);
  return tx;
}

function storeAll(storeName,mode){
  let store = getStore(storeName,mode).getAll()
  return store;
}

function writeResult(resultObj){
  if(resultObj.compId){
    let tx = getStore("results",'readwrite');
    tx.openCursor(resultObj.id).onsuccess = function(e){
      var cursor = e.target.result;
      if (cursor){
        console.log('result already entered');
      }else{
        tx.add(resultObj)
        console.log('add result:', resultObj.boat);
      }
    } 
  }else{
    console.log("no resultObj")
  }
} // 

async function relate(store1, store2, callback){
  let related = new Array;
  let tx = db.transaction([ store1.store, store2.store ], 'readonly')
  tx.oncomplete = function(){
    let txcomplete = 1
    callback(related)
  }
  let results = tx.objectStore(store1.store).index(store1.index)
  let result = results.openCursor(store1.search)
  result.onsuccess = function(e){
    let cursor = event.target.result
    if (cursor){
      let comps = tx.objectStore(store2.store).index(store2.index)
      let comp = comps.get(cursor.value.compId)
      comp.onsuccess = function(e){
        let first = e.target.result
        let second = cursor.value
        //let merged = Object.assign(related, first, second)
        let merged = {...first, ...second}
        //console.log('merged results',merged)
        related.push(merged)
        
      }
    cursor.continue(); 
    }// if cursor
  }// onsuccess
  
}

function relateDone(related){
  related.forEach(function(relatedItems){
  L(relatedItems)
  
    let list = document.querySelectorAll('.finishListTitle').forEach(function(item){
      let dataKey = item.getAttribute('data-key');
      if(dataKey == relatedItems.fleet.replace(/ /g,'')){
        let listItem = document.createElement('li')
        listItem.setAttribute('key',relatedItems.compId)
        listItem.textContent = relatedItems.boat
        item.append(listItem)
      }
    })
    let compPane = document.querySelectorAll('.compRow').forEach(function(item){
      
    })
  })// related.forEach
  
} // relateDone

function buildCompsRows(){
  return new Promise(function(resolve, reject){
  // get insert point and the template
  let insert = document.querySelector('.appTable')
  insert.innerHTML = ''
  let template = document.querySelector('#compTemplate')
  //get comps from db
  let store = getStore('comps').index('boat').getAll()
  store.onsuccess = (e)=>{
    let comps = e.target.result
    comps.forEach(function(comp){
      let clone = template.content.cloneNode(true);
      clone.querySelector('.compPanel').setAttribute('id', comp.id)
      clone.querySelector('.compPanel').setAttribute('data-id', comp.id)
      clone.querySelector('.compId').textContent = comp.id
      clone.querySelector('.helm').textContent = comp.helm
      clone.querySelector('.boatName').textContent = comp.boat
      clone.querySelector('.fleet').textContent = comp.fleet
      clone.querySelector('.rating').textContent = comp.rating
      insert.appendChild(clone);
    }) // forEach
    document.querySelectorAll('.boat').forEach((elem)=>{elem.addEventListener('click',boatClick)})
    document.querySelectorAll('.button').forEach((elem)=>{elem.addEventListener('click',adjustButton)})

  } // onsuccess
  resolve()
}) // buildCompsRows
}

function buildRaceSelect(){
  return new Promise(function(resolve, reject){
  /**
   * need to change dropdown from select/options to html/css
  */
  //get selector
  let selector = document.querySelector('#raceSelector')
  //get races from db
  let races = storeAll('races')
  races.onsuccess = (e)=>{
    let result = races.result
    selector.setAttribute('defaultRaceId',result[0].id)
    result.forEach((item)=>{
      let raceOption = document.createElement('option')
      raceOption.textContent = item.name
      raceOption.setAttribute('value', item.id)
      selector.append(raceOption)
    })
  }
  resolve()
})
} // buildRaceSelect


document.addEventListener('DOMContentLoaded', function(){   
  addListeners()
  function addListeners(){
    document.querySelector('#finishBtn').addEventListener('click', finishButton)
    document.querySelector('#startSetBtn').addEventListener('click', setStart)
    document.querySelector('#codeBtn').addEventListener('click', codeBtn)
    document.querySelector('#raceSelect select').addEventListener('change', raceSelectChange)
    document.querySelector('.btn').addEventListener('mousedown',(e)=>{e.classList.toggle('mousedown')})
    document.querySelector('.btn').addEventListener('mouseup',(e)=>{e.classList.toggle('mouseup')})
  }

});// dom ready

//=============================================================
setTimeout(function(){
  buildCompsRows()
  buildRaceSelect().then(getResultsDb())
  getFleets()
}, 1000);
//=============================================================

function getResultsDb(raceId){
  if(raceId){
    let store = getStore('results').index('raceid').getAll(raceId)
    store.onsuccess = (e)=>{
      let races = e.target.result
      let appTable = document.querySelector('.appTable')
      races.forEach( (item) => {
        let compPanel = document.querySelector(`[id="${item.compid}"]`)
        compPanel.classList.add('finished')
        if(item.finish){
          compPanel.querySelector('.timeDisplay').textContent = item.finish
        }else{
          compPanel.querySelector('.timeDisplay').textContent = item.code
        }
      })
    }
  }else{
    //cant figureout how to get default
    let selectedRace = document.querySelector('#raceSelector')
    selectedRace.children[0]
    //console.dir(selectedRace.children.item(0))
  }
  

}

function raceSelectChange(){
  getResultsDb(this.value)
  let store = getStore('races').get(parseInt(this.value))
  store.onsuccess = (e) => {
    let result = e.target.result
    let raceInfo = document.querySelector('#raceInfo')
    raceInfo.innerHTML = ""
    let name = document.createElement('h3')
    name.textContent = result.name
    let date = document.createElement('p')
    date.textContent = result.date
    let sailed = document.createElement('p')
    sailed.textContent = result.sailed
    raceInfo.appendChild(name)
    raceInfo.appendChild(date)
    raceInfo.appendChild(sailed)
  }
}

function getFleets(){
  let result = [];
  let fleets = storeAll('fleets')
  fleets.onsuccess = (e)=>{
    let result = e.target.result
    makeFinishPane(result)
  }
}
    
function makeFinishPane(fleets){
    let template = document.querySelector('#finishPaneTemplate')
    let insertAt = document.querySelector('#finishPane');
    fleets.forEach(function(e){
        let clone = template.content.cloneNode(true);
        let title = clone.querySelector(".finishListTitle");
        title.textContent = e.name;
        title.setAttribute('id', e.id)
        title.setAttribute('data-key', e.name.replace(/ /g,''))
        insertAt.appendChild(clone);
    }); // forEach

} // makeFinishPane
    
function updateFinishPane(){
  //clear finishPane li's
  document.querySelectorAll('.finishListTitle li').forEach(function(item){
    item.remove();
  })
  //get Current race
  let raceSelect = document.querySelector('#raceSelect select')
  let raceSelected = raceSelect.options[raceSelect.selectedIndex].value
  let store1 = {'store':'results','index':'raceId','search':'106'}
  let store2 = {'store':'comps','index':'id','search':''}
  let rel = relate(store1, store2, relateDone)
}// updateFinishPane

function matchCompToRace(resultsArr){
  LL(resultsArr)
  let store = getStore('comps').index('id')
  resultsArr.forEach(function(item){

  })
}

//Globals
var cue = [];
var finished = [];

function boatClick(e){
  let compPanel = e.target.closest('.compPanel');
  let compId = compPanel.getAttribute('id');
  if(compPanel.classList.contains('finished')){return;}
  if(compPanel.classList.contains('selected')){
      compPanel.classList.remove('selected')
      compPanel.removeAttribute('style')
      compPanel.querySelector('.cueNo').textContent = ''
      compPanel.querySelector('.adj li').removeAttribute('style');
      for(let i=cue.length-1; i>=0;i--){
          if(cue[i]===compId){
              cue.splice(i,1);
          }
      }
  }else{
      cue.push(compId);
      compPanel.classList.add('selected');
  }
  formatRows();
}; // .boat click

function formatRows(){
  let color = '#000099';
  let gradColor = '#66FF33';
  let ratio = '0.20';
  for (let i=0; i<cue.length; i++) {
      let newColor = changeColor(color, ratio, false);
      let next = document.querySelector(`[id="${cue[i]}"]`)
      next.style.borderColor = color
      next.querySelector('.cueNo').textContent = i+1
      next.querySelector('.cueNo').style.color = color
      let styleString = `border-right-color:${color};border-top-color:${color};border-left-color:${color};color:${changeColor(color,'.2',true)}`
      next.querySelector('.adj li').setAttribute('style',styleString)
      next.style.backgroundColor = changeColor(newColor,'.3',false)
      color = newColor;
  };
} // formatRows

function removeFromCue(compId, compPanel){
    compPanel.removeAttribute('style')
    compPanel.querySelector('.cueNo').textContent = ""
    compPanel.querySelector('.adj li').removeAttribute('style');
    for(var i=cue.length-1; i>=0;i--){
        if(cue[i]===compId){
            cue.splice(i,1);
        }
    }
} // removeFromCue

function adjustButton(){
  if (this.closest('.compPanel').classList.contains('finished') ) {
      let compid = this.closest('.compPanel').getAttribute('id')
      let raceid = document.querySelector('#raceSelector').value
      let start = document.querySelector('.start').textContent
      let date = document.querySelector('.date').textContent
      var timeDisplay = this.closest('.compRow').querySelector('.timeDisplay')
      var d = new Date();
      if (this.classList.contains('minus')) {
          //subtract 10ths
          var timeText= timeDisplay.textContent.split(':');
          var t = new Date();
          var d = [t.setHours(timeText[0]), t.setMinutes(timeText[1]), t.setSeconds(timeText[2])];
          t.setTime(t.getTime()-1000);
          var ta = [t.getHours(),t.getMinutes(),t.getSeconds()];
          //add 0 where needed
          if(ta[0]<=9){ta[0]="0"+ta[0]}; if(ta[1]<=9){ta[1]="0"+ta[1]}; if(ta[2]<=9){ta[2]="0"+ta[2]}
          //timeText[3] = new Number(timeText[3])-1;
          let finish = ta.join(':')
          timeDisplay.textContent = finish
          let elapsed = getElapsedTime(start,date,finish)
          updateResult({start,finish,elapsed,raceid,compid})
      }
      else if(this.classList.contains('plus')) {
          //add 10ths
          var timeText= timeDisplay.textContent.split(':');
          var t = new Date();
          var d = [t.setHours(timeText[0]), t.setMinutes(timeText[1]), t.setSeconds(timeText[2])];
          t.setTime(t.getTime()+1000);
          var ta = [t.getHours(),t.getMinutes(),t.getSeconds()];
          //add 0 where needed
          if(ta[0]<=9){ta[0]="0"+ta[0]}; if(ta[1]<=9){ta[1]="0"+ta[1]}; if(ta[2]<=9){ta[2]="0"+ta[2]}
          //console.log(ta);
          //timeText[3] = new Number(timeText[3])-1;
          let finish = ta.join(':')
          timeDisplay.textContent = finish
          let elapsed = getElapsedTime(start,date,finish)
          updateResult({start,finish,elapsed,raceid,compid})
      }
  }
  else if(this.closest('.compPanel').classList.contains('selected')){
      var compPanel = this.closest('.compPanel');
      var cueNo = this.closest('.compRow').querySelector('.cueNo').textContent;
      var compId = compPanel.getAttribute('id');
      removeFromCue(compId, compPanel);
      if (this.classList.contains('minus')) {
          cue.splice(new Number(cueNo), 0, compId);
      }
      else if(this.classList.contains('plus')) {
          cue.splice(new Number(cueNo) - 2, 0, compId);
      }
      console.log('adjust(cue to finish):',cue);
      formatRows();
  }
} // adjustButton
    
function setStart(e){
  var date = new Date();
  var hour = date.getHours();
  var min = date.getMinutes();
  var sec = date.getSeconds();
  document.querySelector('#startTimeInput').value = hour+":"+min+":"+sec
  //.value(hour+":"+min+":"+sec);
};

function finishButton(e){
  var finishTime = new Date().toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1");

  var compPanel = document.querySelector(`[id="${cue[0]}"]`)
  removeFromCue(cue[0], compPanel)
  compPanel.classList.remove('selected')
  compPanel.classList.add('finished')
  compPanel.querySelector('.timeDisplay').textContent = finishTime

//write to db 
  // get raceId from selector
  let raceId = document.querySelector('#raceSelect select').value
  let compId = compPanel.getAttribute('id')
  // get start time for current fleet
  let currentFleet = compPanel.querySelector('.fleet').textContent
  let races = getStore('races')
  let race = races.get(parseInt(raceId))
  race.onsuccess = (e)=>{
    let result = e.target.result
    var currentStart
    result.start.forEach((item)=>{
      let stringToSplit = item.split("|")
      let fleetStart = stringToSplit[1]
      let fleetName = stringToSplit[0].split('^')[1]
      if(currentFleet == fleetName){
        currentStart = fleetStart
      }
    })
    compPanel.querySelector('.start').textContent = currentStart
    compPanel.querySelector('.date').textContent = result.date
    let elapsed = getElapsedTime(currentStart,result.date,finishTime)
    let currentResult = {
      'id':parseInt(raceId+compId),
      'compId': compId,
      'raceId': raceId,
      'elapsed': elapsed,
      'finish': finishTime,
      'start': currentStart
    }
//LL(currentResult)
    let resultStore = getStore('results','readwrite')
//?????????????????????????????????????
//this will fail if result is already there
//need to figure out
    resultStore.add(currentResult)
  } // race.onsuccess
 
} // finishButton

function getElapsedTime(start, date, finish){
  // let today = new Date().toLocaleDateString()
  let startDate = new Date(date+' '+start)
  // let startDate = new Date(today+' '+'12:00:00')
  let finishDate = new Date(date+' '+finish)
  // let finishDate = new Date(today+' '+finishTime)
  let elapsed = convertHMS((finishDate - startDate)/1000)
  //console.log(elapsed)
  return elapsed
}

function convertHMS(value) {
  const sec = parseInt(value, 10);
  let hours   = Math.floor(sec / 3600);
  let minutes = Math.floor((sec - (hours * 3600)) / 60);
  let seconds = sec - (hours * 3600) - (minutes * 60);
  if (hours   < 10) {hours   = "0"+hours;}
  if (minutes < 10) {minutes = "0"+minutes;}
  if (seconds < 10) {seconds = "0"+seconds;}
  return hours+':'+minutes+':'+seconds;
}

function codeBtn(){
  //get select value
  var code = document.querySelector('#codeSelect select').value;
  var compPanel = this.closest('#main').querySelector(`[id="${cue[0]}"]`);
  let compid = compPanel.getAttribute('id')
  let raceid = document.querySelector('#raceSelector').value
  updateResult({compid,raceid,code})
  compPanel.querySelector('.timeDisplay').textContent = code;
  compPanel.classList.remove('selected')
  compPanel.removeAttribute('style')
  compPanel.classList.add('finished')
  compPanel.querySelector('.cueNo').textContent = '';
  compPanel.querySelector('.adj li').removeAttribute('style');
  compPanel.querySelectorAll('.button').forEach( item => item.removeEventListener('click', adjustButton));
  cue.shift();
  formatRows();

};

function updateResult(event){
  /**
   * takes an object using deconstruction
   */
  var merged = {}
  let store = getStore('results').get(parseInt(event.raceid+event.compid))
  store.onsuccess = (e)=>{
    let result = e.target.result
    merged = {...result, ...event}
    let write = getStore('results','readwrite').put(merged)
  }
}

function showClock(){
  var digital=new Date();
  var hours=digital.getHours();
  var minutes=digital.getMinutes();
  var seconds=digital.getSeconds();
  if (minutes<=9){ minutes="0"+minutes; } 
  if (seconds <= 9) { seconds = "0" + seconds; }
  document.querySelector('#clock').textContent = hours+":"+minutes+":"+seconds
  setTimeout(showClock,1000);
} // showClock
showClock();

</script>