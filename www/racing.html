<head>
  <style type="text/css" id="mine"></style>
  <link rel="stylesheet" href="css/racing.css"></link>
</head>
<body>
  <div id="main">
    <div id="infoPane">
      <div id="raceSelect">
        <!-- raceSelected template -- option only-->
        <select>
            <!-- <option value=""></option> -->
        </select>
      </div>
      <!-- NEEDTO: set value from raceData -->
      <div id="startTime"><input id="startTimeInput" type="text" value="18:35:00" size="9"/>
        <div id="startSetBtn" class="btn">Set Start</div>
      </div>
      <div id="save" class="btn">save</div>
      <div id="clock"></div>
    </div>
                
    <div id="mainPane">
      <table cellpadding="0" cellspacing="5px" width="100%">
        <tr><td>
            <div id="compPane">
              <div class="app">
                <table class="appTable" cellpadding="0" cellspacing="5px" height="1400px">
                  <!-- replaced by compTemplate -->
                </table>
              </div><!-- app -->
            </div><!-- compPane -->
          </td><!-- compPane cell -->
          <td width="160px" id="btnPaneCell">          
            <div id="btnPane">
            <div id="finishBtn" class="btn"><div class="finishLabel">Finish</div></div>
            <div id="codeBtn" class="btn"><div id="codeLabel">Set Code</div></div>    
            <div id="codeSelect">
              <select>
                  <option value="DNF">DNF</option>
                  <option value="OCS">OCS</option>
                  <option value="DSQ">DSQ</option>
                  <option value="RAF">RAF</option>
              </select>
            </div>
            <div id="finishPane"><!-- Replaced by finishPaneTemplate --></div>
          </td><!-- btn cell -->
        </tr>
      </table><!-- mainPaneTable -->
    </div> <!-- mainPane -->
  </div><!-- main -->
  </body> 
    
    <!-- Templates -->
    <template id="raceSelectItems">
        <!-- <option value="<?= races[i][1] ?>"><?= races[i][0] ?></option> 
        I dont think i need this, just create it-->
        <option value=""></option>
    </template>

    <template id="finishPaneTemplate">
      <!-- need to set finishListTitle textContent and <ol> id -->
      <ul class="finishListTitle"><!-- <?= fleets[i] ?> -->
        <ol id="" class="finishList"></ol>
      </ul>
    </template>
    
    <template id="compTemplate">
      <tr><td>
        <table id="" class="compPanel" cellpadding="0" cellspacing="0" data-id="">
          <tr class="compRow">
            <td class="boat">
              <div class="cueNo"></div>
              <div class="helm"></div>
              <div class="boatName"></div>
              <div class="fleet"></div>
              <div class="rating"></div>
              <div class="compId"></div>
            </td>
            <td width="20px">
              <div class="adj">
                <ul>
                  <li class="plus button">+</li>
                  <li class="minus button">-</li>
                </ul>
              </div>
            </td>
            <td class="time">
              <table class="timeTable" cellpadding="0" cellspacing="0">
              <tr>
                <td class="timeDisplay"></td>
              </tr>
              </table>
            </td>
          </tr>
        </table>
      </td></tr>
    </template>
    
    <!-- Load the jQuery and jQuery UI libraries. -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <!-- colorChanger script -->
    <script src="js/colorChanger.js"></script>
    <script src="js/importFile.js"></script>
    <!-- <script src="js/dbUtility.js" defer></script> -->
    <script src="js/papaparse.min.js"></script>
    
<script type="text/javascript">// indexedDB Stuff

    var db;
    var dbPromise;
    const dbVersion = 2;
    function openDatabase(name){
        if (!window.indexedDB) { console.log("Your browser doesn't support a stable version of IndexedDB."); }

        let dbPromise = indexedDB.open(name, dbVersion);
    
        dbPromise.onupgradeneeded = function(e) {
            console.log('onupgradeneeded');
            db = e.target.result;
        
            if (!db.objectStoreNames.contains('races')) {
                let store = db.createObjectStore('races', {keyPath: 'id'});
                store.createIndex("name", "name", { unique: true });
                store.createIndex("date", "date", { unique: false });
                store.createIndex("time", "time", { unique: false });
                store.createIndex("sailed", "sailed", { unique: false });
            }
        
            if (!db.objectStoreNames.contains('comps')) {
                let store = db.createObjectStore('comps', {keyPath: 'id'});
                store.createIndex("id", "id", { unique: true });
                store.createIndex("compid", "compid", { unique: false });
                store.createIndex("boat", "boat", { unique: true });
                store.createIndex("fleet", "fleet", { unique: false });
                store.createIndex("helm", "helm", { unique: true });
                store.createIndex("sailno", "sailno", { unique: false });
                store.createIndex("class", "class", { unique: false });
                store.createIndex("rank", "rank", { unique: false });
                store.createIndex("nett", "nett", { unique: false });
                store.createIndex("total", "total", { unique: false });
            }
        
            if (!db.objectStoreNames.contains('fleets')) {
                let store = db.createObjectStore('fleets', {keyPath: 'id'});
                store.createIndex("name", "name", { unique: false });
            }
        
            if (!db.objectStoreNames.contains('results')) { 
                let store = db.createObjectStore('results', {keyPath: 'id', autoIncrement:true});
                store.createIndex("raceid", "raceid", { unique: false });
                store.createIndex("compid", "compid", { unique: false });
                store.createIndex("start", "start", { unique: false });
                store.createIndex("elapsed", "elapsed", { unique: false });
                store.createIndex("finish", "finish", { unique: false });
            }
            return db;
    
        }; // onupgradeneeded
    
        dbPromise.onerror = function(e) { console.warn("Error", e.target.result); };

        dbPromise.onsuccess = function(e) {
            db = e.target.result;
            writeRacesDB(db);
            writeCompsDB(db);
            writeFleetsDB(db)
            writeResultsDB(db)
            return db;
        };

    } // openDatabase
    var dbw = openDatabase('store');

    function writeCompsDB(db){
      let comps = Csv.getComps()
      let transaction = db.transaction("comps", "readwrite");
      let compsData = transaction.objectStore("comps");
      comps.forEach(function(comps){
        let comp = {
            'boat': comps.compboat, 
            'rating': comps.comprating, 
            'fleet': comps.compfleet, 
            'id': comps.compid, 
            'helm': comps.comphelmname, 
            'alias':comps.compalias, 
            'club':comps.compclub, 
            'exclude':comps.compexclude, 
            'high':comps.comphigh, 
            'medicalflag':comps.compmedicalflag, 
            'nett':comps.compnett, 
            'rank':comps.comprank, 
            'total':comps.comptotal
          }
        let request = compsData.add(comp);
        //console.log(comp);
      });
    }

    function writeFleetsDB(db){
         let fleets = Csv.getFleets();
        let tx = makeTX('fleets', 'readwrite');
        let store = tx.objectStore('fleets')
        for (let i = 0; i < fleets.length; i++) {
          let fleet = {'name':fleets[i],'id':i}
          let request = store.put(fleet);
        }
        store.onerror = function(e){
          console.warn('onerror',e)
        }
    }
    
    function writeRacesDB(db){
        let races = Csv.getRaces();
        let transaction = makeTX("races", "readwrite");
        let racesData = transaction.objectStore("races");
        
        for (let i = 0; i < races.length; i++) {
          let race = {
            'id':races[i].id,
            'raceid':races[i].raceid,
            'name':races[i].racename,
            'date':races[i].racedate, 
            'notes':races[i].racenotes, 
            'rank':races[i].racerank, 
            'sailed': races[i].racesailed, 
            'start':races[i].racestart, 
            'time':races[i].racetime
            }
          let request = racesData.put(race);
          //console.log('race',race);
        }
    }

    function writeResultsDB(db){
        let results = Csv.getResults();
        //LL(results)  
        let transaction = makeTX("results", "readwrite");
        let resultsData = transaction.objectStore("results");
        for (let i = 0; i < results.length; i++) {

            let request = resultsData.put(results[i]);
            //console.log(results[i]);
        }
    }
</script>

<script type="text/javascript">
    //LazyLog
    var LL = console.log;

    function makeTX(storeName,mode){
      //console.log('makeTX',db)
      let tx = db.transaction(storeName, mode);
      tx.onerror = (err) => {
        console.log('makeTX onerror',err.target.error);
      }
      return tx;
    }
    
    function getStore(storeName,mode){
      if(mode == 'undefined'){mode = 'readwrite'}
      let tx = makeTX(storeName,mode).objectStore(storeName);
      return tx;
    }

    function storeAll(storeName,mode){
      let store = getStore(storeName,mode).getAll()
      return store;
    }

    function writeResult(resultObj){
      if(resultObj.compId){
        let tx = getStore("results",'readwrite');
        tx.openCursor(resultObj.id).onsuccess = function(e){
          var cursor = e.target.result;
          if (cursor){
            console.log('result already entered');
          }else{
            tx.add(resultObj)
            console.log('add result:', resultObj.boat);
          }
        } 
      }else{
        console.log("no resultObj")
      }
    } // 

    async function relate(store1, store2, callback){
      let related = new Array;
      let tx = db.transaction([ store1.store, store2.store ], 'readonly')
      tx.oncomplete = function(){
        let txcomplete = 1
        callback(related)
      }
      let results = tx.objectStore(store1.store).index(store1.index)
      let result = results.openCursor(store1.search)
      result.onsuccess = function(e){
        let cursor = event.target.result
        if (cursor){
          let comps = tx.objectStore(store2.store).index(store2.index)
          let comp = comps.get(cursor.value.compId)
          comp.onsuccess = function(e){
            let first = e.target.result
            let second = cursor.value
            //let merged = Object.assign(related, first, second)
            let merged = {...first, ...second}
            //console.log('merged results',merged)
            related.push(merged)
            
          }
        cursor.continue(); 
        }// if cursor
      }// onsuccess
      
    }
    
  function relateDone(related){
    related.forEach(function(relatedItems){
    L(relatedItems)
    
      let list = document.querySelectorAll('.finishListTitle').forEach(function(item){
        let dataKey = item.getAttribute('data-key');
        if(dataKey == relatedItems.fleet.replace(/ /g,'')){
          let listItem = document.createElement('li')
          listItem.setAttribute('key',relatedItems.compId)
          listItem.textContent = relatedItems.boat
          item.append(listItem)
        }
      })
      let compPane = document.querySelectorAll('.compRow').forEach(function(item){
        
      })
    })// related.forEach
    
  } // relateDone

document.addEventListener('DOMContentLoaded', function(){   
addListeners()
function addListeners(){
  document.querySelector('#finishBtn').addEventListener('click',finishButton)
}
function buildCompsRows(){
  // get insert point and the template
  let insert = document.querySelector('.appTable')
  let template = document.querySelector('#compTemplate')
  //get comps from db
  let store = getStore('comps').index('boat').getAll()
  store.onsuccess = (e)=>{
    let comps = e.target.result
    comps.forEach(function(comp){
      let clone = template.content.cloneNode(true);
      clone.querySelector('.compPanel').setAttribute('id', comp.id)
      clone.querySelector('.compPanel').setAttribute('data-id', comp.id)
      clone.querySelector('.helm').textContent = comp.helm
      clone.querySelector('.boatName').textContent = comp.boat
      clone.querySelector('.fleet').textContent = comp.fleet
      clone.querySelector('.rating').textContent = comp.rating
      insert.appendChild(clone);
    }) // forEach
    document.querySelectorAll('.boat').forEach((elem)=>{elem.addEventListener('click',boatClick)})
  } // onsuccess

} // buildCompsRows

function buildRaceSelect(){
  //get selector
  //get races from db
  let selector = document.querySelector('#raceSelect select')
  let races = storeAll('races')
  races.onsuccess = (e)=>{
    let result = races.result
    result.forEach((item)=>{
      let raceOption = document.createElement('option')
      raceOption.textContent = item.name
      raceOption.setAttribute('value', item.id)
      selector.append(raceOption)
    })

  }
}

function getFleets(){
  let result = [];
  let fleets = storeAll('fleets')
  fleets.onsuccess = (e)=>{
    let result = e.target.result
    makeFinishPane(result)
  }
}
    
function makeFinishPane(fleets){
    let template = document.querySelector('#finishPaneTemplate')
    let insertAt = document.querySelector('#finishPane');
    fleets.forEach(function(e){
        let clone = template.content.cloneNode(true);
        let title = clone.querySelector(".finishListTitle");
        title.textContent = e.name;
        title.setAttribute('id', e.id)
        title.setAttribute('data-key', e.name.replace(/ /g,''))
        insertAt.appendChild(clone);
    }); // forEach

} // makeFinishPane
    
    function updateFinishPane(){
      //clear finishPane li's
      document.querySelectorAll('.finishListTitle li').forEach(function(item){
        item.remove();
      })
      //get Current race
      let raceSelect = document.querySelector('#raceSelect select')
      let raceSelected = raceSelect.options[raceSelect.selectedIndex].value
      let store1 = {'store':'results','index':'raceId','search':'106'}
      let store2 = {'store':'comps','index':'id','search':''}
      let rel = relate(store1, store2, relateDone)
    }// updateFinishPane

    function matchCompToRace(resultsArr){
      L(resultsArr)
      let store = getStore('comps').index('id')
      resultsArr.forEach(function(item){
    
      })
    }

//Globals
var cue = [];
var finished = [];

function boatClick(e){
  let compPanel = e.target.closest('.compPanel');
  let compId = compPanel.getAttribute('id');
  if(compPanel.classList.contains('finished')){return;}
  if(compPanel.classList.contains('selected')){
      compPanel.classList.remove('selected')
      compPanel.removeAttribute('style')
      compPanel.querySelector('.cueNo').textContent = ''
      compPanel.querySelector('.adj li').removeAttribute('style');
      for(let i=cue.length-1; i>=0;i--){
          if(cue[i]===compId){
              cue.splice(i,1);
          }
      }
  }else{
      cue.push(compId);
      compPanel.classList.add('selected');
  }
  formatRows();
}; // .boat click

function formatRows(){
  let color = '#000099';
  let gradColor = '#66FF33';
  let ratio = '0.20';
  for (let i=0; i<cue.length; i++) {
      let newColor = changeColor(color, ratio, false);
      let next = document.querySelector(`[id="${cue[i]}"]`)
      next.style.borderColor = color
      next.querySelector('.cueNo').textContent = i+1
      next.querySelector('.cueNo').style.color = color
      let styleString = `border-right-color:${color};border-top-color:${color};border-left-color:${color};color:${changeColor(color,'.2',true)}`
      next.querySelector('.adj li').setAttribute('style',styleString)
      next.style.backgroundColor = changeColor(newColor,'.3',false)
      color = newColor;
  };
} // formatRows

function removeFromCue(compId, compPanel){
    compPanel.removeAttribute('style')
    compPanel.querySelector('.cueNo').textContent = ""
    compPanel.querySelector('.adj li').removeAttribute('style');
    for(var i=cue.length-1; i>=0;i--){
        if(cue[i]===compId){
            cue.splice(i,1);
        }
    }
} // removeFromCue

//=============================================================
setTimeout(function(){
  //let fleets = getFleets();
  buildCompsRows()
  buildRaceSelect()
  getFleets()
  //relate('results', 'comps', 'id')
}, 1000);
//=============================================================

 //This is the adjust buttons
    $('.button').on('click',function(){
        if ($(this).closest('.compPanel').hasClass('finished')) {
            var timeDisplay = $(this).closest('.compRow').find('.timeDisplay');
            var d = new Date();
            if ($(this).hasClass('minus')) {
                //subtract 10ths
                var timeText= timeDisplay.text().split(':');
                var t = new Date();
                var d = [t.setHours(timeText[0]), t.setMinutes(timeText[1]), t.setSeconds(timeText[2])];
                t.setTime(t.getTime()-1000);
                var ta = [t.getHours(),t.getMinutes(),t.getSeconds()];
                //add 0 where needed
                if(ta[0]<=9){ta[0]="0"+ta[0]}; if(ta[1]<=9){ta[1]="0"+ta[1]}; if(ta[2]<=9){ta[2]="0"+ta[2]}
                console.log(ta);
                //timeText[3] = new Number(timeText[3])-1;
                timeDisplay.text(ta.join(':'))
            }
            else if($(this).hasClass('plus')) {
                //add 10ths
                var timeText= timeDisplay.text().split(':');
                var t = new Date();
                var d = [t.setHours(timeText[0]), t.setMinutes(timeText[1]), t.setSeconds(timeText[2])];
                t.setTime(t.getTime()+1000);
                var ta = [t.getHours(),t.getMinutes(),t.getSeconds()];
                //add 0 where needed
                if(ta[0]<=9){ta[0]="0"+ta[0]}; if(ta[1]<=9){ta[1]="0"+ta[1]}; if(ta[2]<=9){ta[2]="0"+ta[2]}
                console.log(ta);
                //timeText[3] = new Number(timeText[3])-1;
                timeDisplay.text(ta.join(':'))
            }
        }
        else if($(this).closest('.compPanel').hasClass('selected')){
            var compPanel = $(this).closest('.compPanel');
            var cueNo = $(this).closest('.compRow').find('.cueNo').text();
            var compId = compPanel.attr('id');
            removeFromCue(compId, compPanel);
            if ($(this).hasClass('minus')) {
                cue.splice(new Number(cueNo), 0, compId);
            }
            else if($(this).hasClass('plus')) {
                cue.splice(new Number(cueNo) - 2, 0, compId);
            }
            console.log('adjust(cue to finish):',cue);
            formatRows();
        }
    });

    document.querySelector('.btn').addEventListener('mousedown',()=>{this.toggleClass('mousedown')})
    //$('.btn').on('mousedown',function(){ $(this).toggleClass('mousedown'); });
    document.querySelector('.btn').addEventListener('mouseup',()=>{this.toggleClass('mouseup')})
    //$('.btn').on('mouseup',function(){ $(this).toggleClass('mousedown'); });
     
    $('#startSetBtn').on('click',function(){
         var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        var sec = date.getSeconds();
        document.querySelector('#startTimeInput').val(hour+":"+min+":"+sec);
    });
    
    function finishButton_OLD(){
        var date = new Date();
        var hour = date.getHours();
        var min = date.getMinutes();
        var sec = date.getSeconds();
        if (min<=9){min="0"+min;} 
        if (sec<=9){ sec="0"+sec;}
        
        var compPanel = this.closest('#main').querySelector(`[id="${cue[0]}"]`);
        var boat = compPanel.querySelector('.boatName').textContent = '';
            //console.log(compPanel.find('.boatName').text());
        var compId = compPanel.querySelector('.compId').textContent = '';
            //console.log(compId)
        var fleet = compPanel.querySelector('.fleet').text().replace(/ /g,'')
           //console.log(fleet)
        document.querySelector('#raceSelect option:selected')
        var raceId = document.querySelector('#raceSelect option:selected').val();
        var raceName = document.querySelector('#raceSelect option:selected').text();
        //console.log(raceId);
        if(compPanel.find('.boatName').text() != ''){
        //document.querySelector('#'+fleet)
        //var btnPaneList = $('#'+fleet).append('<li>'+compPanel.find('.boatName').text()+'</li>');
        var btnPaneList = document.querySelector('#'+fleet).append('<li>'+compPanel.find('.boatName').text()+'</li>');
      }
      //TODO: need to write results to DB and then update html from data
      //this will require that we keep track of the race we have selected.
         compPanel.find('.timeDisplay').text(hour+':'+min+':'+sec);
      var resultTime = hour+':'+min+':'+sec;
        compPanel.removeClass('selected').removeAttr('style').addClass('finished').find('.cueNo').text('');
        compPanel.find('.adj li').removeAttr('style');
      cue.shift();
        formatRows();
      //write result to database after each click
      //neeed to extend this functionality to the adjust buttons
      //"rft","19:37:23","26","106"
      var resultObj = {'id':parseInt(raceId+compId), 'boat':boat, 'compId':compId, 'raceId':raceId, 'raceName':raceName,      'resultTime':resultTime, 'timeStamp':Date.now()};
      //console.log(resultObj);
      writeResult(resultObj);
      updateFinishPane();
    
    };

///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////

function finishButton(e){

  let date = new Date();
  let hour = date.getHours();
  let min = date.getMinutes();
  let sec = date.getSeconds();
  if (min<=9){min="0"+min;} 
  if (sec<=9){ sec="0"+sec;}
  let time = `${hour}:${min}:${sec}`;
  var compPanel = document.querySelector(`[id="${cue[0]}"]`)
  removeFromCue(cue[0], compPanel)
  compPanel.classList.remove('selected')
  compPanel.classList.add('finished')
  compPanel.querySelector('.timeDisplay').textContent = time

//write to db 
  // get raceId from selector
  let raceId = document.querySelector('#raceSelect select').value
  let compId = compPanel.getAttribute('id')
  // get start time for current fleet
  let currentFleet = compPanel.querySelector('.fleet').textContent
  let races = getStore('races')
  let race = races.get(parseInt(raceId))
  race.onsuccess = (e)=>{
    let result = e.target.result
    var currentStart
    result.start.forEach((item)=>{
      let stringToSplit = item.split("|")
      let fleetStart = stringToSplit[1]
      let fleetName = stringToSplit[0].split('^')[1]
      if(currentFleet == fleetName){
        currentStart = fleetStart
      }
      
    })
    let finishTime = new Date().getTime()
    LL(finishTime)
    let compTime = new Date().setTime(currentStart)
    LL(compTime)
LL(result.date)
    let currentResult = {
      'id':parseInt(raceId+compId),
      'compId': compId,
      'raceId': raceId,
      'finish': time,
      'start': currentStart
    }
    let resultStore = getStore('results','readwrite')
//?????????????????????????????????????
//this will fail if result is already there
//need to figure out
    resultStore.add(currentResult)
  } // race.onsuccess
 
} // finishButton

///////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////

    
    document.querySelector('#codeBtn').addEventListener('click',function(){
        //get select value
        var code = document.querySelector('#codeSelect select').val();
        //write value to timeDisplay
///////////////////////????? for $(this)
         var compPanel = $(this).closest('#main').find('#'+cue[0]);
         compPanel.find('.timeDisplay').text(code);
        compPanel.removeClass('selected').removeAttr('style').addClass('finished').find('.cueNo').text('');
        compPanel.find('.adj li').removeAttr('style');
        //addToFinished(cue);
        cue.shift();
        formatRows();
      });
          
});// dom ready
    
    function showClock(){
        var Digital=new Date();
        var hours=Digital.getHours();
        var minutes=Digital.getMinutes();
        var seconds=Digital.getSeconds();
        
        if (minutes<=9){
            minutes="0"+minutes;
        } 
        if (seconds <= 9) {
            seconds = "0" + seconds;
        }
        $('#clock').text(hours+":"+minutes+":"+seconds);
        setTimeout(showClock,1000);
    } // showClock
    showClock();
    </script>